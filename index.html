<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faktur Pesanan - Roviana Printing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
             {
}
        }
        .invoice-container {
            width: 1123px;
            background: #fff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .invoice-container, .invoice-container td, .invoice-container th, .invoice-container input, .invoice-container p, .invoice-container label, .invoice-container button {
    font-size: 12pt;
}
.invoice-container p {
    font-size: 9pt;
}
        .invoice-body {
            padding: 1cm;
            flex-grow: 1;
        }
        .dotted-input-container {
            display: flex;
            align-items: center;
            margin-bottom: 0px;
        }
        .dotted-input-container label {
            width: 100px;
            flex-shrink: 0;
            font-size: 12pt;
            
        }
        .dotted-input-container input {
            border: none;
            border-bottom: 1px dotted #374151;
            width: 100%;
            padding: 2px 0;
            font-size: 12pt;
        }
        .dotted-input-container input:focus {
            outline: none;
            border-bottom: 1px solid #3b82f6;
        }
        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 50px;
        }
        .main-table th, .main-table td {
            border: 1px solid #d1d5db;
            padding: 8px;
            height: 23px;
            box-sizing: content-box;
        }
        .main-table th {
            background-color: #f9fafb;
            text-align: center;
            font-weight: 600;
            font-size:12pt;
        }
        .main-table input {
            width: 100%;
            border: none;
            padding: 0 4px;
        }
        .main-table input:focus {
            outline: none;
            background-color: #eff6ff;
        }
        .summary-table {
            width: 100%;
        }
.summary-table td {
    padding: 6px;
    font-size: 12pt;
    
}
#uang-muka {
    border: none;
    background-color: transparent;
    padding: 0;
}
#uang-muka:focus {
    outline: none;
}
        }
        @page {
            size: A4 landscape;
            margin: 1cm;
        }
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                display: block;
                min-height: initial;
            }
            .invoice-container {
                width: 100%;
                height: auto;
                box-shadow: none;
            }
            .invoice-body {
                padding: 30px;
            }
            .dotted-input-container input {
                border-bottom:none;
            }
            input {
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .table-controls, #add-row, #remove-row, #save-button,
      #print-only-button {
                display: none;
            }
        .bottom-footer {        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
    .sembunyikan-saat-cetak {
        display: none !important;
    }
    .main-table th {
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
    footer .bg-gray-50 {
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
 }
@media (max-width: 480px) {
    body {
        padding: 0;
        align-items: flex-start;
    }
    .invoice-container {
        width: 100%;
        height: auto;
        min-height: 100vh;
        box-shadow: none;
    }
    .invoice-body {
        padding: 15px;
    }
    header.flex {
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
    }
    header img {
        width: 60%;
        max-width: 250px;
    }
    header > div:last-child {
        width: 100%;
    }
    .dotted-input-container label {
        width: 80px;
    }
    h1.text-xl {
        text-align: center;
        width: 100%;
    }
    .main-table thead {
        display: none;
    }
    .main-table tr {
        display: block;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 15px;
        padding: 10px;
    }
    .main-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        border: none;
        border-bottom: 1px solid #eee;
        padding: 10px 5px;
        text-align: right;
    }
    .main-table td:last-child {
        border-bottom: none;
    }
    .main-table td::before {
        content: attr(data-label);
        font-weight: bold;
        text-align: left;
        padding-right: 10px;
    }
    .main-table td input {
        width: 50%;
    }
    .main-table td.total {
         font-weight: bold;
    }
    footer.flex {
        flex-direction: column-reverse;
        align-items: flex-start;
        gap: 30px;
    }
    footer > div {
        width: 100% !important;
    }
    .mt-16 {
        margin-top: 1rem;
    }
}
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="invoice-body">
            <header class="flex justify-between items-start mb-8">
                <div class="flex flex-col items-start"> <img src="https://raw.githubusercontent.com/yeliva/faktur/main/images/logo_nama_rp.png" alt="Logo Roviana Printing" width="304">
    
    <div class="mt-6 text-gray-600">
        <p>www.rovianaprinting.com</p>
        <p>Jl. Waru No. 14 Rawamangun, Jakarta Timur</p>
        <p>0853 2230 7373</p>
    </div>

</div>
                <div>
            <h1 class="text-3xl font-semibold text-gray-700 mb-2">FAKTUR PESANAN</h1>
                    <div class="dotted-input-container">
                        <label for="client-name">Kepada Yth,</label>
                        
                        <input type="text" id="client-name">
                    </div>
                    <div class="dotted-input-container">
                        <label for="invoice-date">Tgl.</label>
                        <input type="text" id="invoice-date">
                    </div>
                    <div class="dotted-input-container">
                        <label for="client-phone">Tlp.</label>
                        <input type="text" id="client-phone">
                    </div>
                </div>
            </header>

            <main>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="w-1/12">No</th>
                            <th class="w-5/12">NAMA PESANAN</th>
                            <th class="w-2/12">BANYAK</th>
                            <th class="w-2/12">HARGA SATUAN</th>
                            <th class="w-2/12">JUMLAH</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                    </tbody>
                </table>
                <div class="table-controls mt-4 flex space-x-2">
                    <button id="add-row" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded">
                        + Tambah Baris
                    </button>
                    <button id="remove-row" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">
                        - Kurangi Baris
                    </button>
                </div>
            </main>

            <footer class="mt-8 flex justify-between items-end">
                <div>
                    <p class="font-semibold">Hormat Kami,</p>
                    <div class="mt-3 ml-2 flex items-center space-x-2">
                         <img src="https://raw.githubusercontent.com/yeliva/faktur/main/images/logo_stamp.png" alt="Logo Kecil" class="h-20 w-20" style="transform: rotate(-10deg);"> 
                    </div>
                </div>
              <div class="w-4/12">
    <div class="bg-gray-50 p-2 rounded-lg">
        <table class="summary-table">
    <tr id="subtotal-row">
        <td class="text-left text-gray-800 font-bold">Jumlah</td>
        <td class="text-right font-medium" id="subtotal"></td>
    </tr>
    <tr id="dp-row">
        <td class="text-left text-gray-800 font-bold whitespace-nowrap">Uang Muka</td>
        <td class="text-right">
            <input type="text" id="uang-muka" class="text-right w-full font-medium" oninput="formatInputField(event)">
        </td>
    </tr>
    <tr id="sisa-row">
        <td class="text-left text-gray-800 font-bold">Sisa</td>
        <td class="text-right font-bold" id="sisa"></td>
    </tr>
</table>
    </div>
</div>
            </footer>
             <div class="mt-8 flex space-x-4">
    <button id="save-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded">
        Simpan ke Sheet
    </button>
    <button id="print-only-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded">
        Cetak Faktur
    </button>
</div>
</div> </div>
   <script>
        document.addEventListener('DOMContentLoaded', function () {
    // --- SEMUA FUNGSI DARI FAKTUR ASLI ANDA ADA DI SINI ---
    // (Saya sertakan kembali agar tidak ada yang hilang)

    const flatpickrConfig = {
        dateFormat: "d/m/Y",
        defaultDate: "today"
    };
    let flatpickrInstance = flatpickr("#invoice-date", flatpickrConfig);

    const clientNameInput = document.getElementById('client-name');
    const originalTitle = document.title;
    clientNameInput.addEventListener('input', function() {
        let clientName = this.value.trim().replace(/[\/\\?%*:|"<>]/g, '');
        document.title = clientName ? `Faktur_Roviana Printing_${clientName}` : originalTitle;
    });

    function formatRupiah(angka) {
        if(isNaN(angka) || angka === 0) return '';
        return 'Rp ' + new Intl.NumberFormat('id-ID').format(angka);
    }

    function parseRupiah(rupiahString) {
        if (typeof rupiahString !== 'string') return 0;
        return Number(rupiahString.replace(/[^0-9]/g, ''));
    }

    window.calculateTotal = function () {
        let subtotal = 0;
        document.querySelectorAll('#invoice-items tr').forEach(row => {
            const qtyInput = row.querySelector('.qty');
            const priceInput = row.querySelector('.price');
            const totalCell = row.querySelector('.total');
            if (qtyInput && priceInput && totalCell) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseRupiah(priceInput.value) || 0;
                const lineTotal = qty * price;
                totalCell.textContent = formatRupiah(lineTotal);
                subtotal += lineTotal;
            }
        });

        const uangMuka = parseRupiah(document.getElementById('uang-muka').value) || 0;
        document.getElementById('subtotal').textContent = formatRupiah(subtotal);
        document.getElementById('sisa').textContent = formatRupiah(subtotal - uangMuka);
    };
    
    window.formatInputField = function(e) {
        const value = parseRupiah(e.target.value);
        e.target.value = 'Rp ' + new Intl.NumberFormat('id-ID').format(value);
        calculateTotal();
    };

    function renumberRows() {
        document.querySelectorAll('#invoice-items tr').forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    function addRow() {
        const tbody = document.getElementById('invoice-items');
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
            <td data-label="No" class="text-center"></td>
            <td data-label="Nama Pesanan"><input type="text" class="nama" placeholder="..."></td>
            <td data-label="Banyak"><input type="text" class="qty text-center" oninput="calculateTotal()"></td>
            <td data-label="Harga Satuan"><input type="text" class="price text-right" oninput="formatInputField(event)"></td>
            <td data-label="Jumlah" class="total text-right"></td>
        `;
        renumberRows();
        calculateTotal();
    }

    document.getElementById('add-row').addEventListener('click', addRow);
    document.getElementById('remove-row').addEventListener('click', function() {
        const tbody = document.getElementById('invoice-items');
        if (tbody.rows.length > 0) {
            tbody.deleteRow(-1);
            calculateTotal();
        }
    });

    for(let i=0; i<1; i++) { addRow(); }
    calculateTotal();

    // --- BAGIAN PENTING UNTUK GOOGLE SHEETS ---

    async function simpanKeSheet() {
        const items = [];
        document.querySelectorAll('#invoice-items tr').forEach(row => {
            const namaPesanan = row.querySelector('.nama').value;
            if (namaPesanan) {
                items.push({
                    nama: namaPesanan,
                    banyak: row.querySelector('.qty').value,
                    harga: row.querySelector('.price').value,
                    jumlah: row.querySelector('.total').textContent
                });
            }
        });

        const invoiceData = {
            tanggal: document.getElementById('invoice-date').value,
            kepada: document.getElementById('client-name').value,
            telepon: document.getElementById('client-phone').value,
            items: items
        };
        
        console.log("Data yang akan dikirim:", JSON.stringify(invoiceData, null, 2));
        const url = 'https://script.google.com/macros/s/AKfycby67XUBRaaNmjoHVbbswc4JyXN5sm9wL01GPIVhewikrTHtkP1hLkJCW0Xn1NrafVeHyA/exec';

        try {
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(invoiceData),
                mode: 'no-cors'
            });
            console.log('Permintaan untuk menyimpan data telah dikirim.');
            alert('Data berhasil disimpan ke Google Sheets!'); // Tambahkan notifikasi sukses
        } catch (error) {
            console.error('Terjadi kesalahan jaringan, data tidak dapat dikirim.', error);
            alert('Gagal menyimpan data. Periksa koneksi internet Anda.'); // Tambahkan notifikasi gagal
        }
    }
    
    // HAPUS FUNGSI simpanDanCetak DARI KODE ANDA

    // --- PENGATURAN EVENT LISTENER BARU UNTUK DUA TOMBOL ---
    const saveButton = document.getElementById('save-button');
    if (saveButton) {
        saveButton.addEventListener('click', function(event){
            event.preventDefault();
            simpanKeSheet();
        });
    }

    const printOnlyButton = document.getElementById('print-only-button');
    if (printOnlyButton) {
        printOnlyButton.addEventListener('click', function(event){
            event.preventDefault();
            window.print();
        });
    }
  window.addEventListener('beforeprint', () => {
        console.log('Before print: Menyiapkan halaman untuk dicetak.');
        if (flatpickrInstance) {
            flatpickrInstance.destroy();
        }

        const uangMukaValue = parseRupiah(document.getElementById('uang-muka').value) || 0;
        if (uangMukaValue === 0) {
            document.getElementById('dp-row').classList.add('sembunyikan-saat-cetak');
            document.getElementById('sisa-row').classList.add('sembunyikan-saat-cetak');
        }
    });

    window.addEventListener('afterprint', () => {
        console.log('After print: Mengembalikan halaman ke kondisi semula.');
        flatpickrInstance = flatpickr("#invoice-date", flatpickrConfig);

        document.getElementById('dp-row').classList.remove('sembunyikan-saat-cetak');
        document.getElementById('sisa-row').classList.remove('sembunyikan-saat-cetak');
    });
});         
    </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('Service Worker berhasil didaftarkan.');
        })
        .catch(error => {
          console.log('Pendaftaran Service Worker gagal: ', error);
        });
    });
  }
</script>
</body>
</html>
