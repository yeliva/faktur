<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faktur Pesanan - Roviana Printing</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @page {
            size: A4 landscape;
            margin: 1cm;
        }
        /* Aturan Font Kustom */
        .invoice-container, .invoice-container td, .invoice-container th, .invoice-container input, .invoice-container p, .invoice-container label, .invoice-container button {
            font-size: 12pt;
        }
        .invoice-container h1.text-4xl {
            font-size: 24pt;
        }
        .invoice-container .contact-info p {
            font-size: 9pt;
        }
        footer p.font-semibold {
            font-size: 12pt;
        }
        @media print {
    .print-exact {
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
    }
}
    </style>
</head>
<body class="bg-gray-200 flex justify-center items-start sm:items-center min-h-screen p-0 sm:p-8 print:block print:bg-white print:p-0">
    
    <div class="invoice-container bg-white shadow-md flex flex-col w-full min-h-screen sm:min-h-0 sm:max-w-[1123px] print:w-full print:shadow-none">
        
        <div class="invoice-body flex-grow p-4 sm:p-[1cm]">
            
            <header class="flex flex-col sm:flex-row justify-between items-start mb-8 gap-5">
                <div class="flex flex-col items-start w-full sm:w-auto"> 
                    <img src="https://raw.githubusercontent.com/yeliva/faktur/main/images/logo_rp.svg" alt="Logo Roviana Printing" class=" max-w-[260px]">
                    <div class="contact-info mt-4 text-gray-600">
                        <p>0853 2230 7373</p>
                        <p>www.rovianaprinting.com</p>
                        <p>Jl. Waru No. 14 Rawamangun, Jakarta Timur</p>
                    </div>
                </div>
                <div class="w-full sm:w-auto">
                    <h1 class="text-4xl font-semibold text-gray-700 mb-2 text-center sm:text-left">FAKTUR PESANAN</h1>
                    
                    <div class="flex items-center mb-0">
                        <label for="client-name" class="w-[80px] sm:w-[100px] flex-shrink-0 mr-2.5">Kepada Yth,</label>
                        <input type="text" id="client-name" class="w-full border-0 border-b border-dotted border-gray-700 py-0.5 focus:outline-none focus:border-solid focus:border-blue-500 print:border-b-0">
                    </div>
                    <div class="flex items-center mb-0">
                        <label for="invoice-date" class="w-[80px] sm:w-[100px] flex-shrink-0 mr-2.5">Tgl.</label>
                        <input type="text" id="invoice-date" class="w-full border-0 border-b border-dotted border-gray-700 py-0.5 focus:outline-none focus:border-solid focus:border-blue-500 print:border-b-0">
                    </div>
                    <div class="flex items-center mb-0">
                        <label for="client-phone" class="w-[80px] sm:w-[100px] flex-shrink-0 mr-2.5">Tlp.</label>
                        <input type="text" id="client-phone" class="w-full border-0 border-b border-dotted border-gray-700 py-0.5 focus:outline-none focus:border-solid focus:border-blue-500 print:border-b-0">
                    </div>
                </div>
            </header>

            <main>
                <table class="w-full border-collapse mt-12">
                    <thead class="table-header-group">
                        <tr>
                            <th class="w-1/12 border border-gray-300 p-2 h-[23px] box-content bg-gray-50 text-center font-semibold print-exact">No</th>
                            <th class="w-5/12 border border-gray-300 p-2 h-[23px] box-content bg-gray-50 text-center font-semibold print-exact">NAMA PESANAN</th>
                            <th class="w-2/12 border border-gray-300 p-2 h-[23px] box-content bg-gray-50 text-center font-semibold print-exact">BANYAK</th>
                            <th class="w-2/12 border border-gray-300 p-2 h-[23px] box-content bg-gray-50 text-center font-semibold print-exact">HARGA SATUAN</th>
                            <th class="w-2/12 border border-gray-300 p-2 h-[23px] box-content bg-gray-50 text-center font-semibold print-exact">JUMLAH</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                        </tbody>
                </table>
                <div class="table-controls mt-4 flex space-x-2 print:hidden">
                    <button id="add-row" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded">+ Tambah Baris</button>
                    <button id="remove-row" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">- Kurangi Baris</button>
                </div>
            </main>

            <footer class="mt-8 flex flex-col-reverse sm:flex-row justify-between items-end gap-8 sm:gap-0">
                <div class="w-full sm:w-auto">
                    <p class="font-semibold">Hormat Kami,</p>
                    <div class="mt-3 ml-2">
                         <img src="https://raw.githubusercontent.com/yeliva/faktur/main/images/rp_stempel_merah.png" alt="Stempel Original" class="h-20 w-20 -rotate-10"> 
                    </div>
                </div>
                <div class="w-full sm:w-4/12">
                    <div class="bg-gray-50 p-2 rounded-lg print-exact">
                        <table class="w-full">
                            <tr id="subtotal-row">
                                <td class="p-1.5 text-left text-gray-800 font-bold">Jumlah</td>
                                <td class="p-1.5 text-right font-medium" id="subtotal"></td>
                            </tr>
                            <tr id="dp-row">
                                <td class="p-1.5 text-left text-gray-800 font-bold whitespace-nowrap">Uang Muka</td>
                                <td class="p-1.5 text-right">
                                    <input type="text" id="uang-muka" class="text-right w-full font-medium p-0 border-0 bg-transparent focus:outline-none" oninput="formatInputField(event)">
                                </td>
                            </tr>
                            <tr id="sisa-row">
                                <td class="p-1.5 text-left text-gray-800 font-bold">Sisa</td>
                                <td class="p-1.5 text-right font-bold" id="sisa"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </footer>
            
            <div class="mt-8 flex space-x-4 print:hidden">
                <button id="save-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded">Simpan ke Sheet</button>
                <button id="print-only-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded">Cetak Faktur</button>
            </div>
        </div>
    </div>
   
   <script>
    document.addEventListener('DOMContentLoaded', function () {

        const flatpickrConfig = {
            dateFormat: "d/m/Y",
            defaultDate: "today",
            allowInput: true
        };
        let flatpickrInstance = flatpickr("#invoice-date", flatpickrConfig);

        const clientNameInput = document.getElementById('client-name');
        const originalTitle = document.title;
        clientNameInput.addEventListener('input', function() {
            const clientName = this.value.trim();
            if (clientName) {
                const clientInitial = clientName.substring(0, 3).toUpperCase();
                document.title = `FAK[${clientInitial}]_Roviana Printing`;
            } else {
                document.title = originalTitle;
            }
        });

        function formatRupiah(angka) {
            if (isNaN(angka) || angka === 0) return '';
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(angka);
        }

        function parseRupiah(rupiahString) {
            if (typeof rupiahString !== 'string') return 0;
            return Number(rupiahString.replace(/[^0-9]/g, ''));
        }

        window.calculateTotal = function () {
            let subtotal = 0;
            document.querySelectorAll('#invoice-items tr').forEach(row => {
                const qtyInput = row.querySelector('.qty');
                const priceInput = row.querySelector('.price');
                const totalCell = row.querySelector('.total');
                if (qtyInput && priceInput && totalCell) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseRupiah(priceInput.value) || 0;
                    const lineTotal = qty * price;
                    totalCell.textContent = formatRupiah(lineTotal);
                    subtotal += lineTotal;
                }
            });

            const uangMuka = parseRupiah(document.getElementById('uang-muka').value) || 0;
            document.getElementById('subtotal').textContent = formatRupiah(subtotal);
            document.getElementById('sisa').textContent = formatRupiah(subtotal - uangMuka);
        };

        window.formatInputField = function(e) {
            const value = parseRupiah(e.target.value);
            e.target.value = 'Rp ' + new Intl.NumberFormat('id-ID').format(value);
            calculateTotal();
        };

        function renumberRows() {
            document.querySelectorAll('#invoice-items tr').forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        function addRow() {
            const tbody = document.getElementById('invoice-items');
            if (!tbody) return;
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td class="border border-gray-300 p-2 h-[23px] box-content text-center"></td>
                <td class="border border-gray-300 p-2 h-[23px] box-content"><input type="text" class="nama w-full h-full px-1 focus:bg-blue-50 focus:outline-none" placeholder="..."></td>
                <td class="border border-gray-300 p-2 h-[23px] box-content"><input type="text" class="qty w-full h-full px-1 text-center focus:bg-blue-50 focus:outline-none" oninput="calculateTotal()"></td>
                <td class="border border-gray-300 p-2 h-[23px] box-content"><input type="text" class="price w-full h-full px-1 text-right focus:bg-blue-50 focus:outline-none" oninput="formatInputField(event)"></td>
                <td class="total border border-gray-300 p-2 h-[23px] box-content text-right"></td>
            `;
            renumberRows();
            calculateTotal();
        }

        document.getElementById('add-row').addEventListener('click', addRow);
        document.getElementById('remove-row').addEventListener('click', function() {
            const tbody = document.getElementById('invoice-items');
            if (tbody.rows.length > 0) {
                tbody.deleteRow(-1);
                calculateTotal();
            }
        });

        for (let i = 0; i < 1; i++) { addRow(); }
        calculateTotal();

        async function simpanKeSheet() {
            const items = [];
            document.querySelectorAll('#invoice-items tr').forEach(row => {
                const namaPesanan = row.querySelector('.nama').value;
                if (namaPesanan) {
                    items.push({
                        nama: namaPesanan,
                        banyak: row.querySelector('.qty').value,
                        harga: row.querySelector('.price').value,
                        jumlah: row.querySelector('.total').textContent
                    });
                }
            });

            const invoiceData = {
                tanggal: document.getElementById('invoice-date').value,
                kepada: document.getElementById('client-name').value,
                telepon: document.getElementById('client-phone').value,
                items: items
            };

            console.log("Data yang akan dikirim:", JSON.stringify(invoiceData, null, 2));
            const url = 'https://script.google.com/macros/s/AKfycby67XUBRaaNmjoHVbbswc4JyXN5sm9wL01GPIVhewikrTHtkP1hLkJCW0Xn1NrafVeHyA/exec';

            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(invoiceData),
                    mode: 'no-cors'
                });
                alert('Data berhasil disimpan ke Google Sheets!');
            } catch (error) {
                console.error('Terjadi kesalahan jaringan, data tidak dapat dikirim.', error);
                alert('Gagal menyimpan data. Periksa koneksi internet Anda.');
            }
        }

        const saveButton = document.getElementById('save-button');
        if (saveButton) {
            saveButton.addEventListener('click', function(event) {
                event.preventDefault();
                simpanKeSheet();
            });
        }

        const printOnlyButton = document.getElementById('print-only-button');
        if (printOnlyButton) {
            printOnlyButton.addEventListener('click', function(event) {
                event.preventDefault();
                window.print();
            });
        }
        
        window.addEventListener('beforeprint', () => {
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
            }
            const uangMukaValue = parseRupiah(document.getElementById('uang-muka').value) || 0;
            if (uangMukaValue === 0) {
                document.getElementById('dp-row').classList.add('sembunyikan-saat-cetak');
                document.getElementById('sisa-row').classList.add('sembunyikan-saat-cetak');
            }
        });

        window.addEventListener('afterprint', () => {
            flatpickrInstance = flatpickr("#invoice-date", flatpickrConfig);
            document.getElementById('dp-row').classList.remove('sembunyikan-saat-cetak');
            document.getElementById('sisa-row').classList.remove('sembunyikan-saat-cetak');
        });
    });
   </script>
   <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('Service Worker berhasil didaftarkan.');
            })
            .catch(error => {
              console.log('Pendaftaran Service Worker gagal: ', error);
            });
        });
      }
   </script>
</body>
</html>
